pipeline {
    agent any

    environment {
        APP_ID = ""f8Cq0JwIpIz7gBQ4se_ML""
    }

    parameters {
        string(name: 'DEPLOY_URL_CRED_ID', defaultValue: 'DEPLOY_URL', description: 'Credentials ID for the deployment URL (Secret Text)')
        string(name: 'DEPLOY_KEY_CRED_ID', defaultValue: 'DEPLOY_KEY', description: 'Credentials ID for the deployment API key (Secret Text)')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Python Environment') {
            steps {
                sh '''
                python3 -m venv .venv
                . .venv/bin/activate
                pip install --upgrade pip
                '''
            }
        }

        stage('Install Requirements') {
            steps {
                sh '''
                . .venv/bin/activate
                pip install -r requirements.txt
                '''
            }
        }

        stage('Run Migrations') {
            steps {
                sh '''
                . .venv/bin/activate
                python manage.py makemigrations
                python manage.py migrate
                '''
            }
        }

        stage('Run Unit Tests') {
            steps {
                sh '''
                . .venv/bin/activate
                python manage.py test
                '''
            }
        }

        stage('Start Server') {
            steps {
                sh '''
                . .venv/bin/activate
                nohup python manage.py runserver 0.0.0.0:8000 &
                sleep 10
                '''
            }
        }

        stage('Run API Test Script') {
            steps {
                sh '''
                . .venv/bin/activate
                python check.py
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Tests passed, triggering deployment API..."
            withCredentials([
                string(credentialsId: params.DEPLOY_URL_CRED_ID, variable: 'DEPLOY_URL'),
                string(credentialsId: params.DEPLOY_KEY_CRED_ID, variable: 'DEPLOY_KEY')
            ]) {
                sh '''
                json_payload=$(printf '{"applicationId":"%s"}' "$APP_ID")
                curl -fS -X POST "$DEPLOY_URL" \
                     -H 'accept: application/json' \
                     -H 'Content-Type: application/json' \
                     -H "x-api-key: $DEPLOY_KEY" \
                     --data-binary "$json_payload" \
                     -w "\\nHTTP %{http_code}\\n"
                '''
            }

            // Success email
            mail to: 'ummekulsum9855@gmail.com',
                 subject: "✅ Jenkins Success: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: """
Hello,

The Jenkins pipeline for *${env.JOB_NAME}* (build #${env.BUILD_NUMBER}) has succeeded.

* Branch: ${env.BRANCH_NAME}
* Commit: ${env.GIT_COMMIT}
* Build URL: ${env.BUILD_URL}

Deployment API was triggered successfully.

Regards,  
Jenkins
"""
        }

        failure {
            echo "❌ Pipeline failed, sending error email..."
            mail to: 'ummekulsum9855@gmail.com',
                 subject: "❌ Jenkins Failure: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: """
Hello,

The Jenkins pipeline for *${env.JOB_NAME}* (build #${env.BUILD_NUMBER}) has failed.

* Branch: ${env.BRANCH_NAME}
* Commit: ${env.GIT_COMMIT}
* Build URL: ${env.BUILD_URL}

Please check the Jenkins console output for details.

Regards,  
Jenkins
"""
        }
    }
}
