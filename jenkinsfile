post {
    success {
        echo "✅ Tests passed, triggering deployment API..."

        withCredentials([
            string(credentialsId: 'DEPLOY_URL', variable: 'DEPLOY_URL'),
            string(credentialsId: 'DEPLOY_KEY', variable: 'DEPLOY_KEY')
        ]) {
            sh '''
            json_payload=$(printf '{"applicationId":"%s"}' "$APP_ID")
            echo "Triggering deployment..."
            echo "Deploy URL: $DEPLOY_URL"
            curl -fS -X POST "$DEPLOY_URL" \
                 -H 'accept: application/json' \
                 -H 'Content-Type: application/json' \
                 -H "x-api-key: $DEPLOY_KEY" \
                 --data-binary "$json_payload" \
                 -w "\\nHTTP %{http_code}\\n"
            '''
        }

        mail to: 'ummekulsum9855@gmail.com',
             subject: "✅ Jenkins Success: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
             body: """
Hello,

The Jenkins pipeline for *${env.JOB_NAME}* (build #${env.BUILD_NUMBER}) has succeeded.

* Branch: ${env.BRANCH_NAME}
* Commit: ${env.GIT_COMMIT}
* Build URL: ${env.BUILD_URL}

Deployment API was triggered successfully.

Regards,  
Jenkins
"""
    }

    failure {
        echo "❌ Pipeline failed, sending error email..."
        mail to: 'ummekulsum9855@gmail.com',
             subject: "❌ Jenkins Failure: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
             body: """
Hello,

The Jenkins pipeline for *${env.JOB_NAME}* (build #${env.BUILD_NUMBER}) has failed.

* Branch: ${env.BRANCH_NAME}
* Commit: ${env.GIT_COMMIT}
* Build URL: ${env.BUILD_URL}

Please check the Jenkins console output for details.

Regards,  
Jenkins
"""
    }
}
