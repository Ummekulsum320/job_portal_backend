pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
        timeout(time: 60, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            steps {
                deleteDir()
                git url: 'https://github.com/Ummekulsum320/job_portal_backend.git', branch: 'main'
            }
        }

        stage('Build') {
            steps {
                echo "Building the project..."
                // TODO: Replace with your actual build command. Example for Node:
                // sh 'npm install && npm run build'
                // Example for Maven:
                // sh 'mvn clean package'
                sh 'YOUR_BUILD_COMMAND_HERE'
            }
        }

        stage('Test') {
            steps {
                echo "Running tests..."
                // TODO: Replace with your actual test command. Example:
                // sh 'npm test'
                // or sh 'mvn test'
                sh 'YOUR_TEST_COMMAND_HERE'
            }
            post {
                always {
                    // TODO: Update path to test reports if needed
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Deploy (optional)') {
            when {
                branch 'main'
            }
            steps {
                echo "Deploy stage placeholder. Actual deployment handled in post‑success."
            }
        }
    }

    post {
        success {
            echo "✅ Tests passed, triggering deployment API..."

            withCredentials([
                string(credentialsId: 'DEPLOY_URL', variable: 'DEPLOY_URL'),
                string(credentialsId: 'DEPLOY_KEY', variable: 'DEPLOY_KEY')
            ]) {
                sh '''
                # ensure APP_ID is set either via env or Jenkins Global Variables
                if [ -z "$APP_ID" ]; then
                  echo "ERROR: APP_ID is not defined"
                  exit 1
                fi

                json_payload=$(printf '{"applicationId":"%s"}' "$APP_ID")
                echo "Triggering deployment..."
                echo "Deploy URL: $DEPLOY_URL"
                curl -fS -X POST "$DEPLOY_URL" \
                     -H "accept: application/json" \
                     -H "Content-Type: application/json" \
                     -H "x-api-key: $DEPLOY_KEY" \
                     --data-binary "$json_payload" \
                     -w "\\nHTTP %{http_code}\\n"
                '''
            }

            mail to: 'ummekulsum9855@gmail.com',
                 subject: "✅ Jenkins Success: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: """
Hello,

The Jenkins pipeline for *${env.JOB_NAME}* (build #${env.BUILD_NUMBER}) has succeeded.

* Branch: ${env.BRANCH_NAME}
* Commit: ${env.GIT_COMMIT}
* Build URL: ${env.BUILD_URL}

Deployment API was triggered successfully.

Regards,  
Jenkins
"""
        }

        failure {
            echo "❌ Pipeline failed, sending error email..."
            mail to: 'ummekulsum9855@gmail.com',
                 subject: "❌ Jenkins Failure: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: """
Hello,

The Jenkins pipeline for *${env.JOB_NAME}* (build #${env.BUILD_NUMBER}) has failed.

* Branch: ${env.BRANCH_NAME}
* Commit: ${env.GIT_COMMIT}
* Build URL: ${env.BUILD_URL}

Please check the Jenkins console output for details.

Regards,  
Jenkins
"""
        }

        always {
            echo "This always runs — cleanup, archive artifacts, etc."
            // TODO: Adjust artifact path if different (e.g., if build outputs a .jar or .war elsewhere)
            archiveArtifacts artifacts: '**/target/*.jar', allowEmptyArchive: true
            // Optionally clean workspace here with: deleteDir()
        }
    }
}
